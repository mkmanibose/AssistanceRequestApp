/*!
 * Mvc.Grid 6.0.1
 * https://github.com/NonFactors/AspNetCore.Grid
 *
 * Copyright Â© NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
class MvcGrid{constructor(e,t={}){const r=this,i=r.findGrid(e);if(i.dataset.id)return MvcGrid.instances[parseInt(i.dataset.id)].set(t);r.columns=[],r.element=i,r.loadingDelay=300,r.name=i.dataset.name,r.controller=new AbortController,r.isAjax=Boolean(i.dataset.url),r.prefix=r.name?`${r.name}-`:"",r.filterMode=(i.dataset.filterMode||"").toLowerCase(),i.dataset.id=t.id||MvcGrid.instances.length.toString(),r.url=i.dataset.url?new URL(i.dataset.url,location.href):new URL(location.href),r.url=t.url?new URL(t.url.toString(),location.href):r.url,r.url=t.query?new URL(`?${t.query}`,r.url.href):r.url,r.sort=r.buildSort(),r.filters={default:MvcGridFilter,date:MvcGridDateFilter,guid:MvcGridGuidFilter,text:MvcGridTextFilter,number:MvcGridNumberFilter};const n=i.querySelectorAll(".mvc-grid-row-filters th");for(const[e,t]of i.querySelectorAll(".mvc-grid-headers th").entries())r.columns.push(new MvcGridColumn(r,t,n[e]));const s=i.querySelector(".mvc-grid-pager");s&&(r.pager=new MvcGridPager(r,s)),r.set(t),r.cleanUp(),r.bind(),t.id?MvcGrid.instances[parseInt(t.id)]=r:MvcGrid.instances.push(r),i.children.length||r.reload()}set(e){const t=this;t.loadingDelay="number"==typeof e.loadingDelay?e.loadingDelay:t.loadingDelay,t.url=e.url?new URL(e.url.toString(),location.href):t.url,t.url=e.query?new URL(`?${e.query}`,t.url.href):t.url,t.isAjax="boolean"==typeof e.isAjax?e.isAjax:t.isAjax,t.filters=Object.assign(t.filters,e.filters);for(const e of t.columns)e.filter&&t.filters[e.filter.name]&&(e.filter.instance=new t.filters[e.filter.name](e),e.filter.instance.init());return t}showConfiguration(e){MvcGridPopup.showConfiguration(this,e)}getConfiguration(){return{name:this.name,columns:this.columns.map(e=>({name:e.name,hidden:e.isHidden}))}}reload(){const e=this;if(e.element.dispatchEvent(new CustomEvent("reloadstart",{detail:{grid:e},bubbles:!0})),e.isAjax){const t=new URL(e.url.href);if(e.controller.abort(),MvcGridPopup.lastActiveElement=null,e.controller=new AbortController,t.searchParams.set("_",String(Date.now())),null!=e.loadingDelay){if(e.loader&&e.loader.parentElement)clearTimeout(e.loadingTimerId);else{const t=document.createElement("template");t.innerHTML='<div class="mvc-grid-loader"><div><div></div><div></div><div></div></div></div>',e.loader=t.content.firstElementChild,e.element.appendChild(e.loader)}e.loadingTimerId=setTimeout(()=>{e.loader.classList.add("mvc-grid-loading")},e.loadingDelay)}MvcGridPopup.hide(),fetch(t.href,{signal:e.controller.signal,headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>{if(!e.ok)throw new Error(`Invalid response status: ${e.status}`);return e.text()}).then(t=>{const r=e.element.parentElement,i=document.createElement("template"),n=[].indexOf.call(r.children,e.element);if(i.innerHTML=t.trim(),!i.content.firstElementChild.classList.contains("mvc-grid"))throw new Error("Grid partial should only include grid declaration.");e.element.outerHTML=t;const s=new MvcGrid(r.children[n],{loadingDelay:e.loadingDelay,id:e.element.dataset.id,filters:e.filters,isAjax:e.isAjax,url:e.url});s.element.dispatchEvent(new CustomEvent("reloadend",{detail:{grid:s},bubbles:!0}))}).catch(t=>{if("AbortError"==t.name)return Promise.resolve();return e.loader&&e.loader.parentElement&&e.loader.parentElement.removeChild(e.loader),!e.element.dispatchEvent(new CustomEvent("reloadfail",{detail:{grid:e,reason:t},cancelable:!0,bubbles:!0}))?Promise.resolve():Promise.reject(t)})}else location.href=e.url.href}buildSort(){const e=new Map,t=/(^|,)(.*?) (asc|desc)(?=$|,)/g,r=this.url.searchParams.get(`${this.prefix}sort`)||"";let i=t.exec(r);for(;i;)e.set(i[2],i[3]),i=t.exec(r);return e}findGrid(e){const t=e.closest(".mvc-grid");if(!t)throw new Error("Grid can only be created from within mvc-grid structure.");return t}cleanUp(){delete this.element.dataset.filterMode,delete this.element.dataset.url}bind(){const e=this;for(const t of e.element.querySelectorAll("tbody tr"))t.classList.contains("mvc-grid-empty-row")||t.addEventListener("click",(function(r){const i={};for(const[r,n]of e.columns.entries())i[n.name]=t.cells[r].innerText;this.dispatchEvent(new CustomEvent("rowclick",{detail:{grid:e,data:i,originalEvent:r},bubbles:!0}))}))}}MvcGrid.instances=[],MvcGrid.lang={default:{equals:"Equals","not-equals":"Not equals"},text:{contains:"Contains",equals:"Equals","not-equals":"Not equals","starts-with":"Starts with","ends-with":"Ends with"},number:{equals:"Equals","not-equals":"Not equals","less-than":"Less than","greater-than":"Greater than","less-than-or-equal":"Less than or equal","greater-than-or-equal":"Greater than or equal"},date:{equals:"Equals","not-equals":"Not equals","earlier-than":"Earlier than","later-than":"Later than","earlier-than-or-equal":"Earlier than or equal","later-than-or-equal":"Later than or equal"},guid:{equals:"Equals","not-equals":"Not equals"},filter:{apply:"&#10003;",remove:"&#10008;"},operator:{select:"",and:"and",or:"or"}};class MvcGridColumn{constructor(e,t,r){const i=t.dataset;this.grid=e,this.header=t,this.name=i.name||"",this.isHidden=t.classList.contains("mvc-grid-hidden"),this.filter=i.filter?new MvcGridColumnFilter(this,r):null,this.sort=t.classList.contains("sortable")?new MvcGridColumnSort(this):null,this.cleanUp()}cleanUp(){const e=this.header.dataset;delete e.filterDefaultMethod,delete e.filterApplied,delete e.filterType,delete e.filter,delete e.sortFirst,delete e.sort,delete e.name}}class MvcGridColumnSort{constructor(e){this.column=e,this.button=e.header.querySelector(".mvc-grid-sort"),this.order=(e.header.dataset.sort||"").toLowerCase(),this.first=(e.header.dataset.sortFirst||"asc").toLowerCase(),this.bind()}toggle(e){const t=this,r=t.column.grid,i=t.column.grid.sort,n=r.url.searchParams;t.order==t.first?t.order="asc"==t.order?"desc":"asc":t.order?t.order="":t.order=t.first,e||i.clear(),t.order?i.set(t.column.name,t.order):i.delete(t.column.name);const s=Array.from(i).map(e=>e.join(" ")).join(",");n.delete(`${r.prefix}sort`),s&&n.set(`${r.prefix}sort`,s),r.reload()}bind(){const e=this,t=e.column;t.header.addEventListener("click",r=>{t.filter&&"header"==t.grid.filterMode||/mvc-grid-(sort|filter)/.test(r.target.className)||e.toggle(r.ctrlKey||r.shiftKey)}),e.button.addEventListener("click",t=>{e.toggle(t.ctrlKey||t.shiftKey)})}}class MvcGridColumnFilter{constructor(e,t){const r=[],i=[],n=e.header.dataset,s=e.grid.url.searchParams,l=`${e.grid.prefix+e.name}-`;let a=e.header.querySelector(".mvc-grid-options");"row"==e.grid.filterMode&&(a=t.querySelector("select")),a&&a.classList.contains("mvc-grid-options")&&a.parentElement.removeChild(a);for(const e of s.entries())e[0]!=`${l}op`&&e[0].startsWith(l)&&(i.push(e[0].substring(l.length)),r.push(e[1]));this.column=e,this.rowFilter=t,this.name=n.filter||"default",this.isApplied="True"==n.filterApplied,this.defaultMethod=n.filterDefaultMethod||"",this.type=(n.filterType||"single").toLowerCase(),this.options=a&&a.children.length>0?a:null,this.button=(t||e.header).querySelector(".mvc-grid-filter"),this.inlineInput=t?t.querySelector(".mvc-grid-value"):null,this.first={method:i[0]||"",values:"multi"==this.type?r:r.slice(0,1)},this.operator="double"==this.type&&s.get(`${l}op`)||"",this.second={method:"double"==this.type&&i[1]||"",values:"double"==this.type?r.slice(1,2):[]},this.bind()}apply(){const e=this.column.grid,t=e.url.searchParams,r=this.column.grid.prefix,i=t.get(`${r}sort`);for(const i of e.columns)for(const e of[...t.keys()])e.startsWith(`${r+i.name}-`)&&t.delete(e);t.delete(`${r}sort`),t.delete(`${r}page`),t.delete(`${r}rows`);for(const i of e.columns.filter(e=>e.filter&&(e==this.column||e.filter.isApplied||e.filter.first.values[0]))){const n=i.filter;t.set(`${r+i.name}-${n.first.method}`,n.first.values[0]||"");for(let e=1;"multi"==n.type&&e<n.first.values.length;e++)t.append(`${r+i.name}-${n.first.method}`,n.first.values[e]||"");"excel"==e.filterMode&&"double"==n.type&&(t.set(`${r+i.name}-op`,n.operator||""),t.append(`${r+i.name}-${n.second.method}`,n.second.values[0]||""))}i&&t.set(`${r}sort`,i),e.pager&&e.pager.showPageSizes&&t.set(`${r}rows`,e.pager.rowsPerPage.value),e.reload()}cancel(){const e=this,t=e.column,r=e.column.grid,i=r.url.searchParams;if(e.isApplied){i.delete(`${r.prefix}page`),i.delete(`${r.prefix}rows`);for(const e of[...i.keys()])e.startsWith(`${r.prefix+t.name}-`)&&i.delete(e);r.reload()}else e.first.values=[],e.second.values=[],"excel"!=t.grid.filterMode&&(e.inlineInput.value=""),MvcGridPopup.hide()}bind(){const e=this,t=e.column,r=t.grid.filterMode;e.button.addEventListener("click",()=>{MvcGridPopup.show(e)}),e.options?"row"==r&&"multi"!=e.type?e.inlineInput.addEventListener("change",(function(){e.first.values=[this.value],t.filter.apply()})):"header"!=r&&"row"!=r||e.inlineInput.addEventListener("click",(function(){this.selectionStart==this.selectionEnd&&MvcGridPopup.show(e)})):"excel"!=r&&(e.inlineInput.addEventListener("input",(function(){e.first.values=[this.value],e.instance.validate(this)})),e.inlineInput.addEventListener("keyup",(function(r){13==r.which&&e.instance.isValid(this.value)&&t.filter.apply()})))}}class MvcGridPager{constructor(e,t){this.grid=e,this.element=t,this.pages=t.querySelectorAll("[data-page]"),this.showPageSizes="True"==t.dataset.showPageSizes,this.rowsPerPage=t.querySelector(".mvc-grid-pager-rows"),this.currentPage=this.pages.length?t.querySelector(".active").dataset.page:"1",this.cleanUp(),this.bind()}apply(e){const t=this.grid,r=t.url.searchParams;r.delete(`${t.prefix}page`),r.delete(`${t.prefix}rows`),r.set(`${t.prefix}page`,e),this.showPageSizes&&r.set(`${t.prefix}rows`,this.rowsPerPage.value),t.reload()}cleanUp(){delete this.element.dataset.showPageSizes}bind(){const e=this;for(const t of e.pages)t.addEventListener("click",(function(){e.apply(this.dataset.page)}));e.rowsPerPage.addEventListener("change",()=>{e.apply("1")})}}class MvcGridPopup{static showConfiguration(e,t){const r=this;r.lastActiveElement=document.activeElement,r.element.className="mvc-grid-popup mvc-grid-configuration",r.element.innerHTML='<div class="popup-arrow"></div><div class="popup-content"></div>';const i=r.element.querySelector(".popup-content");i.appendChild(r.createDropzone());for(const t of e.columns)i.appendChild(r.createPreference(t)),i.appendChild(r.createDropzone());e.columns.length&&document.body.appendChild(r.element),r.reposition(e,t),r.bind()}static show(e){if(!e.instance)return;const t=e.instance;this.lastActiveElement=document.activeElement,this.element.className=`mvc-grid-popup ${t.cssClasses}`.trim(),this.element.innerHTML=`<div class="popup-arrow"></div><div class="popup-content">${t.render()}</div>`,document.body.appendChild(this.element),this.bind(),this.setValues(e),this.reposition(e.column.grid,e.button),t.bindOperator(),t.bindMethods(),t.bindValues(),t.bindActions(),this.element.querySelector(".mvc-grid-value").focus()}static hide(e){const t=MvcGridPopup,r=e&&e.target,i=t.element.parentNode,n=!(r&&r.closest&&r.closest(".mvc-grid-popup,.mvc-grid-filter"));i&&n&&(document.body.removeChild(t.element),t.lastActiveElement&&(t.lastActiveElement.focus(),t.lastActiveElement=null))}static setValues(e){this.setValue(".mvc-grid-operator",[e.operator]),this.setValue('.mvc-grid-value[data-filter="first"]',e.first.values),this.setValue('.mvc-grid-value[data-filter="second"]',e.second.values),this.setValue('.mvc-grid-method[data-filter="first"]',[e.first.method]),this.setValue('.mvc-grid-method[data-filter="second"]',[e.second.method])}static setValue(e,t){const r=this.element.querySelector(e);r&&("SELECT"==r.tagName&&r.multiple?[].forEach.call(r.options,e=>{e.selected=t.indexOf(e.value)>=0}):r.value=t[0]||"")}static createPreference(e){const t=this,r=document.createElement("span"),i=document.createElement("input"),n=document.createElement("label");return i.type="checkbox",n.draggable=!0,n.className="mvc-grid-column",e.filter&&e.filter.inlineInput?r.innerText=e.filter.inlineInput.placeholder:r.innerText=e.header.innerText.trim(),i.checked=!e.isHidden,i.addEventListener("change",()=>{const t=e.grid.columns.indexOf(e);for(const r of e.grid.element.querySelectorAll("tr"))i.checked?r.children[t].classList.remove("mvc-grid-hidden"):r.children[t].classList.add("mvc-grid-hidden");e.isHidden=!i.checked,e.grid.element.dispatchEvent(new CustomEvent("gridconfigure",{detail:{grid:e.grid},bubbles:!0}))}),n.addEventListener("dragstart",()=>{t.draggedColumn=e,t.draggedElement=n,n.style.opacity="0.4",n.parentElement.classList.add("mvc-grid-dragging")}),n.addEventListener("dragend",()=>{t.draggedColumn=null,t.draggedElement=null,n.style.opacity="",n.parentElement.classList.remove("mvc-grid-dragging")}),n.appendChild(i),n.appendChild(r),n}static createDropzone(){const e=document.createElement("div");return e.className="mvc-grid-dropzone",e.addEventListener("dragenter",()=>{e.classList.add("hover")}),e.addEventListener("dragover",e=>{e.preventDefault()}),e.addEventListener("dragleave",()=>{e.classList.remove("hover")}),e.addEventListener("drop",()=>{const t=this,r=t.draggedElement,i=t.draggedColumn.grid;if(e!=r.previousElementSibling&&e!=r.nextElementSibling){const n=[].indexOf.call(t.element.querySelectorAll(".mvc-grid-dropzone"),e),s=i.columns.indexOf(t.draggedColumn);e.parentElement.insertBefore(r.previousElementSibling,e),e.parentElement.insertBefore(r,e);for(const e of i.element.querySelectorAll("tr"))e.insertBefore(e.children[s],e.children[n]);i.columns.splice(n-(s<n?1:0),0,i.columns.splice(s,1)[0]),i.element.dispatchEvent(new CustomEvent("gridconfigure",{detail:{grid:i},bubbles:!0}))}e.classList.remove("hover")}),e}static reposition(e,t){const r=this.element,i=getComputedStyle(r),n=r.querySelector(".popup-arrow");let{top:s,left:l}=(t||e.element).getBoundingClientRect();if(s+=window.pageYOffset-parseFloat(i.borderTopWidth),l+=window.pageXOffset-parseFloat(i.borderLeftWidth),t){l-=parseFloat(i.marginLeft)-t.offsetWidth/2+26;const e=26-parseFloat(getComputedStyle(n).borderLeftWidth),a=parseFloat(i.marginLeft)+r.offsetWidth+parseFloat(i.marginRight),o=Math.max(0,l+a-window.pageXOffset-document.documentElement.clientWidth);s+=t.offsetHeight/3*2+n.offsetHeight-parseFloat(i.marginTop),n.style.left=`${Math.max(0,e+o)}px`,l-=o}r.style.left=`${Math.max(0,l)}px`,r.style.top=`${Math.max(0,s)}px`,n.style.display=t?"":"none"}static bind(){window.addEventListener("mousedown",this.hide),window.addEventListener("touchstart",this.hide)}}MvcGridPopup.element=document.createElement("div");class MvcGridFilter{constructor(e){this.methods=[],this.column=e,this.cssClasses="",this.type=e.filter.type,this.mode=e.grid.filterMode,this.methods=["equals","not-equals"]}init(){const e=this,t=e.column.filter;t.options||"excel"==e.mode||e.validate(t.inlineInput),t.first.method||(t.first.method=t.defaultMethod),t.second.method||(t.second.method=t.defaultMethod),e.methods.indexOf(t.first.method)<0&&(t.first.method=e.methods[0]),e.methods.indexOf(t.second.method)<0&&(t.second.method=e.methods[0])}isValid(e){return!e||!0}validate(e){this.isValid(e.value)?e.classList.remove("invalid"):e.classList.add("invalid")}render(){return`<div class="popup-filter">\n                    ${this.renderFilter("first")}\n                </div>\n                ${"excel"==this.mode&&"double"==this.type?`${this.renderOperator()}\n                    <div class="popup-filter">\n                        ${this.renderFilter("second")}\n                    </div>`:""}\n                ${this.renderActions()}`}renderFilter(e){const t=this.column.filter.options,r=MvcGrid.lang[this.column.filter.name]||{},i="multi"==this.type?" multiple":"";return`<div class="popup-group">\n                    <select class="mvc-grid-method" data-filter="${e}">\n                        ${this.methods.map(e=>`<option value="${e}">${r[e]||""}</option>`).join("")}\n                    </select>\n                </div>\n                <div class="popup-group">${t?`<select class="mvc-grid-value" data-filter="${e}"${i}>\n                          ${t.innerHTML}\n                       </select>`:`<input class="mvc-grid-value" data-filter="${e}">`}\n                </div>`}renderOperator(){const e=MvcGrid.lang.operator;return`<div class="popup-operator">\n                    <div class="popup-group">\n                        <select class="mvc-grid-operator">\n                            <option value="">${e.select}</option>\n                            <option value="and">${e.and}</option>\n                            <option value="or">${e.or}</option>\n                        </select>\n                    </div>\n                </div>`}renderActions(){const e=MvcGrid.lang.filter;return`<div class="popup-actions">\n                    <button type="button" class="mvc-grid-apply" type="button">${e.apply}</button>\n                    <button type="button" class="mvc-grid-cancel" type="button">${e.remove}</button>\n                </div>`}bindOperator(){const e=this.column.filter,t=MvcGridPopup.element.querySelector(".mvc-grid-operator");t&&t.addEventListener("change",(function(){e.operator=this.value}))}bindMethods(){const e=this.column.filter;for(const t of MvcGridPopup.element.querySelectorAll(".mvc-grid-method"))t.addEventListener("change",(function(){e[this.dataset.filter].method=this.value}))}bindValues(){const e=this;for(const t of MvcGridPopup.element.querySelectorAll(".mvc-grid-value"))"SELECT"==t.tagName?t.addEventListener("change",()=>{if(e.column.filter[t.dataset.filter].values=[].filter.call(t.options,e=>e.selected).map(e=>e.value),"excel"!=e.mode){const r=e.column.filter.inlineInput;"header"==e.mode||"row"==e.mode&&"multi"==e.type?r.value=[].filter.call(t.options,e=>e.selected).map(e=>e.text).join(", "):r.value=t.value,e.validate(r)}}):(t.addEventListener("input",()=>{if(e.column.filter[t.dataset.filter].values=[t.value],"excel"!=e.mode){const r=e.column.filter.inlineInput;r.value=e.column.filter[t.dataset.filter].values.join(", "),e.validate(r)}e.validate(t)}),t.addEventListener("keyup",(function(t){13==t.which&&e.isValid(this.value)&&e.column.filter.apply()})),e.validate(t))}bindActions(){const e=this.column.filter,t=MvcGridPopup.element;t.querySelector(".mvc-grid-apply").addEventListener("click",e.apply.bind(e)),t.querySelector(".mvc-grid-cancel").addEventListener("click",e.cancel.bind(e))}}class MvcGridTextFilter extends MvcGridFilter{constructor(e){super(e),this.methods=["contains","equals","not-equals","starts-with","ends-with"]}}class MvcGridNumberFilter extends MvcGridFilter{constructor(e){super(e),this.methods=["equals","not-equals","less-than","greater-than","less-than-or-equal","greater-than-or-equal"]}isValid(e){return!e||/^(?=.*\d+.*)[-+]?\d*[.,]?\d*$/.test(e)}}class MvcGridDateFilter extends MvcGridFilter{constructor(e){super(e),this.methods=["equals","not-equals","earlier-than","later-than","earlier-than-or-equal","later-than-or-equal"]}}class MvcGridGuidFilter extends MvcGridFilter{constructor(e){super(e),this.cssClasses="mvc-grid-guid-filter"}isValid(e){return!e||/^[0-9A-F]{8}[-]?([0-9A-F]{4}[-]?){3}[0-9A-F]{12}$/i.test(e)}}document.getElementById("SearchInput").addEventListener("input",(function(){const e=document.querySelectorAll(".sidebar li"),t=this.value.toLowerCase().split(" ");for(let r=0;r<e.length;r++){let i=!0;const n=e[r].innerText.toLowerCase().split(" ");for(let e=0;e<t.length;e++){let r=!1;for(let i=0;i<n.length;i++)n[i].indexOf(t[e])>=0&&(r=!0);r||(i=!1)}e[r].style.display=i?"":"none"}})),document.querySelectorAll(".mvc-grid").forEach(e=>new MvcGrid(e));